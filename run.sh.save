#!/bin/bash

# run.sh - åå°”è¡—æ¯é¸¡å¯åŠ¨è„šæœ¬

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# é¡¹ç›®ç›®å½•
PROJECT_DIR="$HOME/åå°”è¡—æ¯é¸¡"
cd "$PROJECT_DIR"

echo -e "${YELLOW}ğŸ” åå°”è¡—æ¯é¸¡äº¤æ˜“ç³»ç»Ÿ${NC}"
echo "======================================"

# æ£€æŸ¥Pythonç¯å¢ƒ
check_python() {
    echo -e "${BLUE}æ£€æŸ¥Pythonç¯å¢ƒ...${NC}"
    
    if ! command -v python3 &> /dev/null; then
        echo -e "${RED}âŒ Python3æœªå®‰è£…${NC}"
        exit 1
    fi
    
    # åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    if [ ! -d "venv" ]; then
        echo -e "${YELLOW}åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ...${NC}"
        python3 -m venv venv
    fi
    
    # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
    source venv/bin/activate
    echo -e "${GREEN}âœ… Pythonç¯å¢ƒå°±ç»ª${NC}"
}

# æ£€æŸ¥ä¾èµ–
check_dependencies() {
    echo -e "${BLUE}æ£€æŸ¥ä¾èµ–...${NC}"
    
    # æ£€æŸ¥PostgreSQL
    if ! pgrep -x "postgres" > /dev/null; then
        echo -e "${YELLOW}å¯åŠ¨PostgreSQL...${NC}"
        brew services start postgresql@14 2>/dev/null || brew services start postgresql 2>/dev/null
    fi
    
    # æ£€æŸ¥Redis
    if ! pgrep -x "redis-server" > /dev/null; then
        echo -e "${YELLOW}å¯åŠ¨Redis...${NC}"
        brew services start redis 2>/dev/null
    fi
    
    # å®‰è£…PythonåŒ…ï¼ˆå¦‚æœéœ€è¦ï¼‰
    if ! pip show polygon-api-client &> /dev/null; then
        echo -e "${YELLOW}å®‰è£…Pythonä¾èµ–...${NC}"
        pip install -r requirements.txt
    fi
    
    echo -e "${GREEN}âœ… ä¾èµ–æ£€æŸ¥å®Œæˆ${NC}"
}

# åˆå§‹åŒ–æ•°æ®åº“
init_database() {
    echo -e "${BLUE}æ£€æŸ¥æ•°æ®åº“...${NC}"
    
    # æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å­˜åœ¨
    if ! psql -lqt | cut -d \| -f 1 | grep -qw trading; then
        echo -e "${YELLOW}åˆ›å»ºæ•°æ®åº“...${NC}"
        createdb trading
        psql trading < init.sql
        echo -e "${GREEN}âœ… æ•°æ®åº“å·²åˆ›å»º${NC}"
    else
        echo -e "${GREEN}âœ… æ•°æ®åº“å·²å­˜åœ¨${NC}"
    fi
}

# åˆ›å»ºæ—¥å¿—ç›®å½•
create_logs() {
    if [ ! -d "logs" ]; then
        mkdir -p logs
        echo -e "${GREEN}âœ… æ—¥å¿—ç›®å½•å·²åˆ›å»º${NC}"
    fi
}

# æ˜¾ç¤ºèœå•
show_menu() {
    echo ""
    echo "======================================"
    echo -e "${BLUE}è¯·é€‰æ‹©è¿è¡Œæ¨¡å¼:${NC}"
    echo "1) ğŸš€ å®Œæ•´è¿è¡Œï¼ˆå®šæ—¶æ‰«æï¼‰"
    echo "2) ğŸ” å•æ¬¡æ‰«æ"
    echo "3) ğŸ“Š å®æ—¶ç›‘æ§"
    echo "4) ğŸ§ª æµ‹è¯•è¿æ¥"
    echo "5) ğŸ“ˆ æŸ¥çœ‹æ—¥å¿—"
    echo "6) ğŸ›‘ åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "7) ğŸ—‘ï¸  æ¸…ç†æ—¥å¿—"
    echo "8) ğŸ“± åå°è¿è¡Œ"
    echo "9) é€€å‡º"
    echo "======================================"
    read -p "é€‰æ‹© [1-9]: " choice
}

# è¿è¡Œä¸»ç¨‹åº
run_main() {
    echo -e "${GREEN}å¯åŠ¨äº¤æ˜“ç³»ç»Ÿ...${NC}"
    python main.py
}

# å•æ¬¡æ‰«æ
run_once() {
    echo -e "${GREEN}è¿è¡Œå•æ¬¡æ‰«æ...${NC}"
    python main.py once
}

# ç›‘æ§æ¨¡å¼
run_monitor() {
    echo -e "${GREEN}å¯åŠ¨ç›‘æ§å™¨...${NC}"
    python monitor.py
}

# æµ‹è¯•è¿æ¥
test_connections() {
    echo -e "${BLUE}æµ‹è¯•APIè¿æ¥...${NC}"
    python test_apis.py
}

# æŸ¥çœ‹æ—¥å¿—
view_logs() {
    if [ -f "logs/trading_signals.log" ]; then
        echo -e "${BLUE}æœ€è¿‘çš„äº¤æ˜“ä¿¡å·:${NC}"
        tail -n 20 logs/trading_signals.log | python -m json.tool 2>/dev/null || tail -n 20 logs/trading_signals.log
    else
        echo -e "${YELLOW}æš‚æ— æ—¥å¿—${NC}"
    fi
}

# åœæ­¢æœåŠ¡
stop_services() {
    echo -e "${YELLOW}åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    
    # åœæ­¢Pythonè¿›ç¨‹
    pkill -f "python main.py" 2>/dev/null
    pkill -f "python monitor.py" 2>/dev/null
    
    # åœæ­¢æ•°æ®åº“æœåŠ¡ï¼ˆå¯é€‰ï¼‰
    read -p "æ˜¯å¦åœæ­¢æ•°æ®åº“æœåŠ¡? [y/N]: " stop_db
    if [[ $stop_db == "y" || $stop_db == "Y" ]]; then
        brew services stop postgresql 2>/dev/null
        brew services stop redis 2>/dev/null
    fi
    
    echo -e "${GREEN}âœ… æœåŠ¡å·²åœæ­¢${NC}"
}

# æ¸…ç†æ—¥å¿—
clean_logs() {
    read -p "ç¡®å®šè¦æ¸…ç†æ‰€æœ‰æ—¥å¿—å—? [y/N]: " confirm
    if [[ $confirm == "y" || $confirm == "Y" ]]; then
        rm -rf logs/*
        echo -e "${GREEN}âœ… æ—¥å¿—å·²æ¸…ç†${NC}"
    fi
}

# åå°è¿è¡Œ
run_background() {
    echo -e "${GREEN}åœ¨åå°å¯åŠ¨ç³»ç»Ÿ...${NC}"
    nohup python main.py > logs/system_$(date +%Y%m%d).log 2>&1 &
    echo $! > .pid
    echo -e "${GREEN}âœ… ç³»ç»Ÿå·²åœ¨åå°è¿è¡Œ (PID: $(cat .pid))${NC}"
    echo -e "${YELLOW}æŸ¥çœ‹æ—¥å¿—: tail -f logs/system_$(date +%Y%m%d).log${NC}"
}

# ä¸»æµç¨‹
main() {
    # åˆå§‹åŒ–
    check_python
    check_dependencies
    init_database
    create_logs
    
    # æ˜¾ç¤ºèœå•
    while true; do
        show_menu
        
        case $choice in
            1)
                run_main
                break
                ;;
            2)
                run_once
                ;;
            3)
                run_monitor
                break
                ;;
            4)
                test_connections
                ;;
            5)
                view_logs
                ;;
            6)
                stop_services
                ;;
            7)
                clean_logs
                ;;
            8)
                run_background
                break
                ;;
            9)
                echo -e "${YELLOW}ğŸ‘‹ å†è§!${NC}"
                exit 0
                ;;
            *)
                echo -e "${RED}æ— æ•ˆé€‰æ‹©${NC}"
                ;;
        esac
    done
}

# è¿è¡Œ
main

